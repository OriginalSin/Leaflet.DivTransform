<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Image Transformation Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

	<script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>

	<script src="http://scanex.github.io/Leaflet.imageTransform/src/L.ImageTransform.js"></script>
	

	<script src="../src/L.DivTransform.js"></script>
    
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0px;
        }
    </style>
</head>
<body>
	<div id="map"></div>

	<script>

        var item = {
            href: 'per.mp4',	// https://www.youtube.com/watch?v=8APykL7FaWA
            width: 1280,
            height: 720,
			anchors: [[55.734885087148086, 37.57973849773407],[55.73387629706783, 37.57740497589111],[55.734583056924244, 37.57642865180969],[55.735594848975055, 37.57864952087402]]
		};
        var gmxImage = new L.DivTransform('', item.anchors, {
            opacity: 1,
            width: item.width,
            height: item.height,
            html: '<video id="myvideo" width="' + item.width + '" height="' + item.height + '" src="' + item.href + '" ></video>'
        }).on('loaded', function() {
			var cont = gmxImage.getContainer();
			if (cont) {
				var video = cont.getElementsByTagName('video')[0];
				if (video) {
					video.oncanplaythrough = video.onended = video.play;
				}
			}
		});

		var cloudmadeUrl = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
			cloudmade = new L.TileLayer(cloudmadeUrl, {maxZoom: 18}),
			map = new L.Map('map', {layers: [cloudmade], center: new L.LatLng(55.734799, 37.577861), zoom: 18});

		// To modify the anchor points on image
        L.gmxPolygon = L.Polygon.extend({
            disableAddRemovePoints: function () {
                var poly = this.editing._poly;
                for(var key in this.editing._markerGroup._layers) {
                    var marker = this.editing._markerGroup._layers[key];
                    if(marker._index === undefined) marker._icon.style.display = 'none';
                    else {
                        marker.off('click');
                        marker.on('drag', function (ev){poly.fire('drag');}, this);
                    }
                }
            }
        });
        var polygon = new L.gmxPolygon(item.anchors, { fillOpacity: 0 });
		polygon.editing.enable();
		map.addLayer(polygon);
		polygon.disableAddRemovePoints();
		polygon.on('drag', function(ev) {
            var newAnchors = [];
            for(var i = 0, len = ev.target._latlngs.length; i < len; i++) {
                var marker = ev.target._latlngs[i];
                newAnchors.push([marker.lat, marker.lng]);
            }
            gmxImage.setAnchors(newAnchors);
			gmxImage.setOpacity(0.5);
		});
		map.on('mouseup', function(ev) {
			gmxImage.setOpacity(1);
		});
		map.addLayer(gmxImage);
        gmxImage.bringToBack();

	</script>
</body>
</html>
